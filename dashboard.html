<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Time Tracker</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        :root {
            --primary: #6366f1;
            --secondary: #4f46e5;
            --background: #f8fafc;
            --text: #0f172a;
            --success: #22c55e;
            --danger: #ef4444;
        }

        body {
            background: var(--background);
            min-height: 100vh;
            padding: 2rem;
            font-family: 'Segoe UI', system-ui, sans-serif;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
        }

        .timer-container {
            background: white;
            border-radius: 1rem;
            padding: 2rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            margin-bottom: 2rem;
            text-align: center;
        }

        .timer-display {
            font-size: 3rem;
            font-weight: bold;
            color: var(--text);
            margin: 1.5rem 0;
        }

        .button-group {
            display: flex;
            gap: 1rem;
            justify-content: center;
            margin-top: 1rem;
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 0.5rem;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            color: white;
        }

        .btn-primary {
            background: var(--primary);
        }

        .btn-primary:hover {
            background: var(--secondary);
        }

        .btn-secondary {
            background: var(--danger);
        }

        .btn-secondary:hover {
            background: #dc2626;
        }

        .history-table {
            background: white;
            border-radius: 1rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            margin-top: 1.5rem;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid #e2e8f0;
        }

        th {
            background: #f8fafc;
            color: #64748b;
            font-weight: 600;
        }
    </style>
</head>
<body>

<div class="container">
    <div class="timer-container">
        <div class="timer-display" id="timer">08:00:00</div>

        <div class="button-group">
            <button class="btn btn-primary" id="punchInBtn">Punch In</button>
            <button class="btn btn-secondary" id="punchOutBtn" disabled>Punch Out</button>
            <button class="btn btn-danger" id="logoutBtn">Logout</button>
        </div>
    </div>

    <div class="history-table">
        <table>
            <thead>
                <tr>
                    <th>Date</th>
                    <th>Punch In</th>
                    <th>Punch Out</th>
                    <th>Duration</th>
                    <th>Remaining Time</th>
                </tr>
            </thead>
            <tbody id="historyBody"></tbody>
        </table>
    </div>
</div>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>

<script>
    // Firebase config
    const firebaseConfig = {
        apiKey: "AIzaSyBSmA6GbO0yFSzx4WlOUNbzgSq9HvDrx48",
        authDomain: "time-management-f9a62.firebaseapp.com",
        projectId: "time-management-f9a62",
        storageBucket: "time-management-f9a62.firebasestorage.app",
        messagingSenderId: "102201778852",
        appId: "1:102201778852:web:89f7d19eec85d50b57bc31",
        measurementId: "G-6YL0RXGR9G"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();

    let timer;
    let totalSeconds = 8 * 3600;
    let remainingSeconds = totalSeconds;
    let startTime = null;

    const timerDisplay = document.getElementById('timer');
    const punchInBtn = document.getElementById('punchInBtn');
    const punchOutBtn = document.getElementById('punchOutBtn');
    const logoutBtn = document.getElementById('logoutBtn');
    const historyBody = document.getElementById('historyBody');

    // ‚úÖ Authentication check
    auth.onAuthStateChanged(user => {
        if (!user) {
            window.location.href = 'login.html';
        } else {
            console.log("User logged in:", user.uid);
            loadHistory(user.uid);
        }
    });

    // ‚úÖ Timer update
    function startTimer() {
        timer = setInterval(() => {
            remainingSeconds--;
            timerDisplay.textContent = formatTime(remainingSeconds);
            if (remainingSeconds <= 0) {
                clearInterval(timer);
                handlePunchOut();
            }
        }, 1000);
    }

    function formatTime(seconds) {
        const hrs = String(Math.floor(seconds / 3600)).padStart(2, '0');
        const mins = String(Math.floor((seconds % 3600) / 60)).padStart(2, '0');
        const secs = String(seconds % 60).padStart(2, '0');
        return `${hrs}:${mins}:${secs}`;
    }

    async function handlePunchIn() {
        const user = auth.currentUser;
        if (!user) {
            alert("You must be logged in to punch in!");
            window.location.href = 'login.html';
            return;
        }

        startTime = new Date();
        punchInBtn.disabled = true;
        punchOutBtn.disabled = false;
        startTimer();

        await db.collection('users').doc(user.uid).collection('punchData').add({
            punchIn: startTime,
            punchOut: null
        });
    }

    async function handlePunchOut() {
        const curren_user = auth.currentUser;
        if (!curren_user) {
            alert("You must be logged in to punch out!");
            window.location.href = 'login.html';
            return;
        }
        clearInterval(timer);
        punchInBtn.disabled = false;
        punchOutBtn.disabled = true;

        const user = auth.currentUser;
        const punchOutTime = new Date();

        const query = await db.collection('users').doc(user.uid).collection('punchData')
            .where('punchOut', '==', null).get();

        query.forEach(async (doc) => {
            await doc.ref.update({ punchOut: punchOutTime });
        });

        loadHistory(user.uid);
    }

    async function loadHistory(userId) {
        historyBody.innerHTML = '';
        const query = await db.collection('users').doc(userId).collection('punchData')
        .orderBy('punchIn', 'desc')
        .get();

        const latestDataPerDay = {};

        query.forEach(doc => {
            const data = doc.data();
            const dateKey = data.punchIn.toDate().toLocaleDateString();

            // Only store the latest entry for the day
            if (!latestDataPerDay[dateKey] || data.punchIn.toDate() > latestDataPerDay[dateKey].punchIn.toDate()) {
                latestDataPerDay[dateKey] = data;
            }
        });

        for (const dateKey in latestDataPerDay) {
        const data = latestDataPerDay[dateKey];
        const punchInTime = data.punchIn.toDate();
        const punchOutTime = data.punchOut ? data.punchOut.toDate() : null;
        let duration = '--';
        let remainingTime = '--';
        let hoverMessage = '';

        if (punchOutTime) {
            duration = ((punchOutTime - punchInTime) / 1000 / 60).toFixed(2) + ' mins';
            if ((punchOutTime - punchInTime) >= (8 * 60 * 60 * 1000)) {
                hoverMessage = '‚úÖ Congratulations! You have completed 8 hours and earned a reward!';
            } else {
                hoverMessage = '‚è≥ You have not completed 8 hours yet.';
            }
        } else {
            const timeElapsed = (new Date() - punchInTime) / 1000;
            const timeRemaining = (8 * 60 * 60) - timeElapsed;
            remainingTime = timeRemaining > 0
                ? formatTime(timeRemaining)
                : '‚úÖ Completed 8 hours';

            if (timeRemaining > 0) {
                hoverMessage = `‚è≥ Keep going! You have ${formatTime(timeRemaining)} left to complete 8 hours.`;
            } else {
                hoverMessage = '‚úÖ You have completed 8 hours!';
            }
        }

        // ‚úÖ Add row with hover message
        historyBody.innerHTML += `
            <tr>
                <td title="üìÖ Date of entry">${dateKey}</td>
                <td title="${hoverMessage}">${punchInTime.toLocaleTimeString()}</td>
                <td title="${punchOutTime ? '‚úÖ Completed work' : '‚è≥ Work in progress'}">
                    ${punchOutTime ? punchOutTime.toLocaleTimeString() : '--'}
                </td>
                <td title="${hoverMessage}">${duration}</td>
                <td title="${hoverMessage}">${remainingTime}</td>
            </tr>
        `;
    }
    }

    function formatTime(seconds) {
        seconds = Math.floor(seconds);
        const hrs = String(Math.floor(seconds / 3600)).padStart(2, '0');
        const mins = String(Math.floor((seconds % 3600) / 60)).padStart(2, '0');
        const secs = String(seconds % 60).padStart(2, '0');
        return `${hrs}:${mins}:${secs}`;
    }  
    

    punchInBtn.addEventListener('click', handlePunchIn);
    punchOutBtn.addEventListener('click', handlePunchOut);
    logoutBtn.addEventListener('click', () => auth.signOut());
</script>

</body>
</html>
